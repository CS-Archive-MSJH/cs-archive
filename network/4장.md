# 4 전송 계층

## 4-1 전송 계층 개요 : IP의 한계와 포트

### 네트워크 계층과 응용 계층 사이의 전송 계층
  * IP 한계 보완: 신뢰할 수 있는 통신과 연결형 통신 기능 제공
  * 응용 계층의 프로세스(실행 중인 프로그램) 식별: 포트 번호 활용

### 신뢰할 수 없는 통신과 비연결형 통신 
  - IP의 특징
    * 신뢰할 수 없는 (비신뢰성) 프로토콜(Unreliable Protocol)
    * 비연결형 프로토콜(Connectionless Protocol)
  
  - IP 패킷의 전달 = 신뢰성이 없는 통신 + 비연결형 통신

  - 신뢰할 수 없는 통신
    * 패킷이 수신지까지 제대로 전송되었다는 보장을 하지 않음
    * 통신 과정에서 패킷이 잘못 전송 되어도 이를 확인하지 않고,
      재전송도 하지 않으며, 순서대로 패킷이 도착할 것이라는 보장도 하지 않는다는 의미
    * 최선형 전달(Best Effort Delivery)라고 하며, 최선을 다해보겠지만, 전송 결고ㅔ애 대해서 어떠한 보장도 하지 않겠다는 뜻.     

  - 비연결형 통신
    * 송수신 호스트 간에 사전 연결 수립 작업을 거치지 않음
    * 그저 수신지를 향해 패킷을 보내기만 할 뿐
    * 전송 계층에는 송수신 호스트 간에 사전 연결 수립 작업을 거침. 이를 TCP라함.

  - IP는 왜 신뢰할 수 없는, 비연결형 통신을 할까?
    - 주된 이유는 성능! 신뢰할 수 없는 통신 = 성능에 악영향
    - 신뢰성 있는 전송이 모든 경우에 필요한 것은 아님

  - TCP 
    * 연결형 통신을 가능하게 함
      - 송수신하는 동안에는 연결을 유지하고, 송수신이 끝나면 연결을 종료
    * 신뢰성 있는 통신을 가능하게 함
      - 재전송을 통한 오류 제어, 흐름 제어, 혼잡 제어 등 다양한 기능들을 제공
      
  - UDP 
    * 신뢰할 수 없는 통신, 비연결형 통신을 가능하게함
    * TCP보다 비교적 빠른 전송이 가능

  <img src="assets/chapter4-1.png" width="800" />

### 응용 계층을 식별하는 전송 계층
  - 포트를 활용한 애플리케이션 식별
    * 포트(Port): 네트워크 상의 애플리케이션 식별 정보
      - 패킷은 실행 중인 특정 애플리케이션 프로세스까지 전달되어야함.

  <img src="assets/chapter4-2.png" width="800" />

  - 포트의 분류
    * 패킷 내 수신지 포트와 송신지 포트를 통해 송수신지 호스트의 애플리케이션을 식별
    * 16비트로 표현 가능: 사용 가능한 포트의 수는 2^16(65536)개
      - 할당 가능한 포트 번호: 0번~65535번

    | 포트 종류    | 포트 번호 범위   |
    |:-------------:|:------------:|
    | 잘 알려진 포트(Well-known Port)| 0~1023     |
    | 등록된 포트(Registered Port)  | 1024~49151 |
    | 동적 포트(Dynamic Port)  | 49152~65535 |

  - 잘 알려진 포트
    * 0번부터 1023번까지의 포트
    * 시스템 포트(System Port)
    * 범용적으로 사용되는 애플리케이션 프로토콜이 일반적으로 사용하는 포트 번호를 의미

    | 잘 알려진 포트 번호    | 설명  |
    |:-------------:|:------------:|
    | 20, 21 | FTP |
    | 22 | SSH |
    | 23 | TELNET |    
    | 53 | DNS |   
    | 68,68 | DHCP |   
    | 80 | HTTP |  
    | 443 | HTTPS |   

  - 등록된 포트
    * 포트 번호 1024번부터 49151번까지
    * 잘 알려진 포트에 비해서 덜 범용적
    * 흔히 사용되는 애플리케이션 프로토콜에 할당하기 위해 사용

    | 등록된 포트 번호    | 설명  |
    |:-------------:|:------------:|
    | 1194 | OpenVPN |
    | 1433 | Microsoft SQL Server 데이터베이스 |
    | 3306 | MySQL 데이터베이스 |    
    | 6379 | Redis |   
    | 8080 | HTTP 대체 |
    | 27017 | Mongo DB |

  - 인터넷 할당 번호 관리 기관(IANA; Internet Assigned Numbers Authority)    
    * 잘 알려진 포트와 등록된 포트
    * 물론 포트 번호는 권고일 뿐 강제 사항은 아님  

  - 동적 포트, 사설 포트(Private Port), 임시 포트(Ephemeral Port)
    * 특별히 관리되지 않는 포트 번호 범위: 자유롭게 사용 가능
    * 서버는 대부분 잘 알려진 포트와 등록된 포트 사용
    * 클라이언트는 대부분 동적 포트 사용
      ex) 웹 브라우저

    <img src="assets/chapter4-3.png" width="800" />

   - '특정 호스트'에서 실행 중인 '특정 애플리케이션 프로세스' 식별
    * IP 주소: 포트 번호 형식
      ex) 192.168.0.15:8000

### 포트를 활용하는 기술: 포트 기반 NAP
  - NAT
    * NAT 변환 테이블: 변환의 대상이 되는 IP 주소 쌍
    * 사설 IP 주소 하나당 공인 IP 주소 하나가 대응: 많은 사설 IP 주소를 변환하기에는 무리가 있음
    * 공인 IP 주소의 낭비: 사설 IP 주소의 수만큼 공인 IP 주소가 필요

    | NAT 변환 테이블  |
    |:-------------:|
    | 네트워크 외부 | 네트워크 내부 |
    |:-------------:|:------------:|
    | 1.2.3.4 | 192.168.0.5 |
    | 1.2.3.5 | 192.168.0.6 |

  - 포트 기반의 NAT, NAPT
    * NAPT(Network Address Port Translation) 또는 APT (Address Port Translation)
    * NAPT는 NAT 테이블에 변활할 IP 주소 쌍과 더불어 포트 번호도 함께 기록하고, 변환
    * 하나의 공인 IP 주소(1)를 여러 사설 IP 주소(N)로 공유 가능
      - 사설 IP 주소: 공인 IP 주소를 N:1로 변환
      - 공인 IP 주소 수 부족 문제를 개선한 기술

      | NAT 변환 테이블  |
      |:-------------:|
      | 네트워크 외부 | 네트워크 내부 |
      |:-------------:|:------------:|
      | 1.2.3.4:6200 | 192.168.0.5:1025 |
      | 1.2.3.4:6201 | 192.168.0.6:1026 |

 ### 포트 포워딩(Port Forwarding)
 
 - 가령...
  * 네트워크 내부의 여러 호스트가 공인 IP 주소를 공유하는 상황
  * 네트워크 외부에서 내부로 (원격 좁석을 시도하는 등) 통신을 시작하는 상황
  * 외부 호스트 입장에서는 어떤 IP 주소(및 포트)를 수신지 주소로 삼아야할까?

 - 포트 포워딩
  * 네트워크 내 특정 호스트에 IP 주소와 포트 번호를 미리 할당하고,
  * 해당 IP 주소:포트 번호로써 해당 호스트에게 패킷을 전달하는 기능

  | 서비스 포트 | 프로토콜 | IP 주소 |  내부 포트 |
  |:-------------:|:------------:|:------------:|:------------:|
  | 1234 | TCP/IP | 192.168.100.100 | 1025 | 
  | 4321 | TCP/IP | 192.168.100.101 | 1026 | 
  
  * 공인 IP 주소:1234로 전송한 패킷은 192.168.100.100:1025로 전달
  * 공인 IP 주소:4321로 전송한 패킷은 192.168.100.101:1026으로 전달

  ### ICMP(Internet Control Message Protocol)

  - IP의 신뢰할 수 없는 비연결형 통신, 이 전송 특성을 보완하는 ICMP
    * IP 패킷 전송 과정에 대한 피드백 메시지 제공
    * 피드백 메시지?
      - 1. 전송 과정에서 발생한 문제 상황에 대한 오류 보고
      - 2. 네트워크에 대한 진단 정보(네트워크상의 정보 제공)

  - ICMP 메시지 = 타입(Type) + 코드(코드)
    * 타입: ICMP 메시지 유형 번호
    * 코드: 구체적인 메시지 내용 번호

    | 전송 과정에서 발생한 문제 상황에 대한 오류 보고  |
    |:-------------:|
    | 타입 이름(타입 번호)                 | 코드 번호 | 코드 설명                                      |
    |-------------------------------------|-----------|------------------------------------------------|
    | 수신지 도달 불가(3) : 특정 패킷이 수신지까지 도달할 수 없음을 나타냄                  | 0         | 네트워크 도달 불가                             |
    | 수신지 도달 불가(3) : 특정 패킷이 수신지까지 도달할 수 없음을 나타냄                         | 1         | 호스트 도달 불가                               |
    | 수신지 도달 불가(3) : 특정 패킷이 수신지까지 도달할 수 없음을 나타냄                    | 2         | 프로토콜 도달 불가; 수신지에서 특정 프로토콜을 사용할 수 없음 |
    | 수신지 도달 불가(3) : 특정 패킷이 수신지까지 도달할 수 없음을 나타냄                         | 3         | 포트 도달 불가                                 |
    | 수신지 도달 불가(3) : 특정 패킷이 수신지까지 도달할 수 없음을 나타냄      | 4         | 단편화가 필요하지만 DF가 1로 설정되어 단편화할 수 없음 |
    | 시간 초과 (11)                      | 0         | TTL 만료        


    | 네트워크에 대한 진단 정보(네트워크상의 정보 제공) |
    |:-------------:|
    | 타입 이름(타입 번호)  | 코드 번호 | 코드 설명                                   |
    |-----------------------|-----------|-------------------------------------------|
    | 에코 요청 (8)         | 0         | 에코 요청                                  |
    | 에코 응답 (0)         | 0         | 에코 요청에 대한 응답                      |
    | 라우터 광고 (9)       | 0         | 라우터 광고; 라우터가 호스트에게 자신을 알림 |

    * Ping, Traceroute 명령어는 ICMP 메시지를 기반으로 동작
    * ICMP는 IP의 보조일 뿐: 신뢰성의 완전 보장 X
    